{% extends 'base.html' %}
{% load static %}

{% block title %} Model Training & Statistics {% endblock %}

{% block content %}

<h1>Model Configuration</h1>
<form method="POST" action="">
    {% csrf_token %}
    <label for="model_name">Model Name:</label>
    <input type="text" id="model_name" name="model_name" placeholder="e.g., OpenFinAL/FINGPT_QA_OPENELM" required>
    <br>

    <label for="learning_rate">Learning Rate:</label>
    <input type="number" step="0.00001" name="learning_rate" value="2e-5">
    <br>

    <label for="num_epochs">Number of Epochs:</label>
    <input type="number" name="num_epochs" value="3">
    <br>

    <label for="batch_size">Batch Size:</label>
    <input type="number" name="batch_size" value="1">
    <br>

    <label for="dataset_name">Dataset Name:</label>
    <input type="text" id="dataset_name" name="dataset_name" placeholder="e.g., FinGPT/fingpt-fiqa_qa" value="FinGPT/fingpt-fiqa_qa">
    <br>

    <label for="num_questions">Number of Questions (for Statistics):</label>
    <input type="number" id="num_questions" name="num_questions" placeholder="Default: 10">
    <br>

    <button type="submit" onclick="startTraining(event)">Start Training & Evaluate</button>
</form>

<h2>Model Evaluation Results</h2>
<div id="model-eval-results" class="results-box"></div>

<h2>Training Logs</h2>
<div id="log-container">Waiting for logs...</div>

<script>
    let eventSource;

    async function startTraining(event) {
        event.preventDefault();
        const logContainer = document.getElementById("log-container");
        const modelName = document.getElementById("model_name").value.trim();
        const numQuestions = document.getElementById("num_questions").value || 10;
        const formData = new FormData(event.target.form);
        formData.append("num_questions", parseInt(numQuestions));

        if (!modelName) {
            alert("Please enter a model name!");
            return;
        }

        logContainer.textContent = "üöÄ Training started...\n";

        if (eventSource) {
            eventSource.close();
        }

        try {
            const trainResponse = await fetch("/api/train_model/", {
                method: "POST",
                body: formData,
            });

            const trainData = await trainResponse.json();
            if (trainData.status === "success") {
                logContainer.textContent += "‚úÖ Training initiated successfully.\n";
                await startLogStreaming();

                logContainer.textContent += "\nüèÅ Training completed! Fetching Model Statistics...\n";
                await evaluateModel(modelName, numQuestions);
            } else {
                logContainer.textContent += `‚ùå Error: ${trainData.message}\n`;
            }
        } catch (error) {
            logContainer.textContent += `‚ö†Ô∏è Request failed: ${error}\n`;
        }
    }

    async function evaluateModel(modelName, numQuestions) {
        const resultContainer = document.getElementById("model-eval-results");
        resultContainer.innerHTML = "<p>Evaluating models... Please wait...</p>";

        const formData = new FormData();
        formData.append("models", modelName);
        formData.append("num_questions", parseInt(numQuestions));

        try {
            const response = await fetch("/api/model_statistics/", {
                method: "POST",
                body: formData,
            });

            if (response.ok) {
                const results = await response.json();
                let tableHtml = `
                    <h3>Model Evaluation Results</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Model</th>
                                <th>ROUGE1</th>
                                <th>ROUGE2</th>
                                <th>ROUGE-L</th>
                                <th>ROUGE-LSum</th>
                                <th>BERTScoreF1</th>
                                <th>BERTScorePrecision</th>
                                <th>BERTScoreRecall</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                Object.keys(results).forEach(model => {
                    const modelResults = results[model];
                    tableHtml += `
                        <tr>
                            <td>${model}</td>
                            <td>${modelResults.ROUGE1.toFixed(4)}</td>
                            <td>${modelResults.ROUGE2.toFixed(4)}</td>
                            <td>${modelResults.ROUGEL.toFixed(4)}</td>
                            <td>${modelResults.ROUGELSUM.toFixed(4)}</td>
                            <td>${modelResults.BERTScoreF1.toFixed(4)}</td>
                            <td>${modelResults.BERTScorePrecision.toFixed(4)}</td>
                            <td>${modelResults.BERTScoreRecall.toFixed(4)}</td>
                        </tr>
                    `;
                });

                tableHtml += "</tbody></table>";
                resultContainer.innerHTML = tableHtml;
            } else {
                const errorMessage = await response.text();
                resultContainer.innerHTML = `<p style="color: red;">Error: ${errorMessage}</p>`;
            }
        } catch (error) {
            resultContainer.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
        }
    }

    function startLogStreaming() {
        const logContainer = document.getElementById("log-container");
        if (eventSource) {
            eventSource.close();
        }

        eventSource = new EventSource("/api/stream-training/");

        return new Promise((resolve) => {
            eventSource.onmessage = function (event) {
                logContainer.innerHTML += `<pre>${event.data}</pre>`;
                logContainer.scrollTop = logContainer.scrollHeight;

                if (event.data.includes("[END_OF_TRAINING]")) {
                    eventSource.close();
                    resolve();
                }
            };

            eventSource.onerror = function () {
                logContainer.innerHTML += `<pre>‚ö†Ô∏è Connection lost. Retrying...</pre>`;
                eventSource.close();
                setTimeout(startLogStreaming, 3000);
            };
        });
    }
</script>

{% endblock %}
